{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1>{{ title }}</h1>
            <p class="text-muted">Convert OpenAPI specifications to stored prompts for OpenAI.</p>
        </div>
    </div>

    {% if systems %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Available Systems</h5>
                </div>
                <div class="card-body">
                    <p>Select a system to convert its OpenAPI specification to stored prompts:</p>
                    
                    <div class="list-group">
                        {% for system in systems %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">{{ system.name }}</h6>
                                <small class="text-muted">{{ system.openapi_spec }}</small>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="convertSystem('{{ system.name }}')">
                                Convert
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="alert alert-info">
                <h5>No Systems Available</h5>
                <p>No external systems with OpenAPI specifications are configured. Add systems with OpenAPI specs to use this feature.</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Conversion Results -->
    <div id="conversion-results" class="row mt-4" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Conversion Results</h5>
                </div>
                <div class="card-body">
                    <div id="conversion-content">
                        <!-- Results will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
async function convertSystem(systemName) {
    const resultsDiv = document.getElementById('conversion-results');
    const contentDiv = document.getElementById('conversion-content');
    
    // Show loading state
    contentDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div><p class="mt-2">Converting OpenAPI specification...</p></div>';
    resultsDiv.style.display = 'block';
    
    try {
        const response = await fetch('/admin/prompt-conversion/api/convert', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `system_name=${encodeURIComponent(systemName)}`,
            credentials: 'include'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        displayConversionResults(data);
        
    } catch (error) {
        console.error('Conversion failed:', error);
        contentDiv.innerHTML = `
            <div class="alert alert-danger">
                <h6>Conversion Failed</h6>
                <p>Error: ${error.message}</p>
            </div>
        `;
    }
}

function displayConversionResults(data) {
    const contentDiv = document.getElementById('conversion-content');
    
    let html = `
        <div class="alert alert-success">
            <h6>Conversion Complete for ${data.system_name}</h6>
            <p>Copy the content below to create stored prompts in the OpenAI dashboard.</p>
        </div>
    `;
    
    // Tools section
    html += `
        <div class="mb-4">
            <h6>Tools JSON</h6>
            <p class="text-muted">${data.instructions.tools}</p>
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Tools for ${data.system_name}</span>
                    <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('tools-json')">Copy</button>
                </div>
                <div class="card-body">
                    <pre id="tools-json" class="mb-0"><code>${JSON.stringify(data.tools, null, 2)}</code></pre>
                </div>
            </div>
        </div>
    `;
    
    // System prompts section
    html += `
        <div class="mb-4">
            <h6>System Prompts</h6>
            <p class="text-muted">${data.instructions.system_prompts}</p>
    `;
    
    data.system_prompts.forEach((prompt, index) => {
        html += `
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>System Prompt ${index + 1}</span>
                    <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('prompt-${index}')">Copy</button>
                </div>
                <div class="card-body">
                    <pre id="prompt-${index}" class="mb-0"><code>${prompt}</code></pre>
                </div>
            </div>
        `;
    });
    
    html += `</div>`;
    
    contentDiv.innerHTML = html;
}

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    const text = element.textContent;
    
    navigator.clipboard.writeText(text).then(() => {
        // Show temporary success message
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = 'Copied!';
        button.classList.remove('btn-outline-primary');
        button.classList.add('btn-success');
        
        setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-primary');
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy: ', err);
        alert('Failed to copy to clipboard');
    });
}
</script>
{% endblock %}
